{% extends 'base.html' %}

{% block title %}Dashboard - Pulse{% endblock %}

{% block page_title %}Dashboard{% endblock %}

{% block extra_css %}
<style>
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        position: relative;
        cursor: pointer;
    }

    .stat-card.patients {
        border-left: 4px solid var(--primary-purple);
    }

    .stat-card.appointments {
        border-left: 4px solid var(--info);
    }

    .stat-card.birthdays {
        border-left: 4px solid var(--warning);
    }

    .stat-card.revenue {
        border-left: 4px solid var(--success);
    }

    .chart-container {
        position: relative;
        height: 300px;
        margin: 1rem 0;
    }

    .appointments-sidebar {
        background: var(--white);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        padding: 1.5rem;
        height: fit-content;
        position: sticky;
        top: calc(var(--header-height) + 2rem);
    }

    .appointment-item {
        display: flex;
        align-items: center;
        padding: 1rem;
        border-radius: var(--border-radius);
        margin-bottom: 0.75rem;
        transition: var(--transition);
        border-left: 3px solid var(--light-purple);
    }

    .appointment-item:hover {
        background-color: var(--light-gray);
        transform: translateX(5px);
    }

    .appointment-time {
        background: var(--primary-purple);
        color: var(--white);
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 500;
        margin-right: 1rem;
        min-width: 60px;
        text-align: center;
    }

    .appointment-patient {
        flex: 1;
        font-weight: 500;
        color: var(--dark-gray);
    }

    .appointment-status {
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.75rem;
        font-weight: 500;
        text-transform: uppercase;
    }

    .status-confirmed {
        background-color: rgba(39, 174, 96, 0.1);
        color: var(--success);
    }

    .status-pending {
        background-color: rgba(243, 156, 18, 0.1);
        color: var(--warning);
    }

    .quick-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 2rem;
    }

    .quick-action-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1.5rem;
        background: var(--white);
        border: 2px solid var(--light-purple);
        border-radius: var(--border-radius);
        color: var(--primary-purple);
        text-decoration: none;
        transition: var(--transition);
        font-weight: 500;
    }

    .quick-action-btn:hover {
        background: var(--primary-purple);
        color: var(--white);
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(142, 68, 173, 0.3);
    }

    .quick-action-btn i {
        margin-right: 0.75rem;
        font-size: 1.25rem;
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--dark-gray);
        margin-bottom: 1.5rem;
        position: relative;
        padding-left: 1rem;
    }

    .section-title::before {
        content: '';
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 4px;
        height: 20px;
        background: linear-gradient(180deg, var(--primary-purple), var(--light-purple));
        border-radius: 2px;
    }

    .chart-card {
        background: var(--white);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .no-appointments {
        text-align: center;
        color: var(--medium-gray);
        padding: 2rem;
        font-style: italic;
    }

    .birthday-item {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        background-color: rgba(243, 156, 18, 0.1);
        border-radius: var(--border-radius);
        margin-bottom: 0.5rem;
    }

    .birthday-icon {
        color: var(--warning);
        margin-right: 0.75rem;
        font-size: 1.25rem;
    }

    .stat-trend {
        display: flex;
        align-items: center;
        font-size: 0.875rem;
        margin-top: 0.5rem;
    }

    .trend-up {
        color: var(--success);
    }

    .trend-down {
        color: var(--danger);
    }

    .trend-icon {
        margin-right: 0.25rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- Statistics Cards -->
<div class="stats-grid">
    <!-- Pacientes Cadastrados -->
    <div class="card stat-card patients">
        <div class="stat-card">
            <div class="stat-value">{{ total_pacientes|default:0 }}</div>
            <div class="stat-label">Pacientes Cadastrados</div>
            <div class="stat-trend trend-up">
                <i class="fas fa-arrow-up trend-icon"></i>
                +{{ pacientes_novos_mes|default:0 }} este mês
            </div>
            <i class="fas fa-users stat-icon"></i>
        </div>
    </div>

    <!-- Agendamentos Hoje -->
    <div class="card stat-card appointments">
        <div class="stat-card">
            <div class="stat-value">{{ agendamentos_hoje|default:0 }}</div>
            <div class="stat-label">Agendamentos Hoje</div>
            <div class="stat-trend">
                <i class="fas fa-calendar-check trend-icon"></i>
                {{ agendamentos_confirmados|default:0 }} confirmados
            </div>
            <i class="fas fa-calendar-alt stat-icon"></i>
        </div>
    </div>

    <!-- Aniversariantes -->
    <div class="card stat-card birthdays">
        <div class="stat-card">
            <div class="stat-value">{{ aniversariantes_hoje|default:0 }}</div>
            <div class="stat-label">Aniversariantes Hoje</div>
            <div class="stat-trend">
                <i class="fas fa-birthday-cake trend-icon"></i>
                Parabenizar pacientes
            </div>
            <i class="fas fa-birthday-cake stat-icon"></i>
        </div>
    </div>

    <!-- Faturamento do Mês -->
    <div class="card stat-card revenue">
        <div class="stat-card">
            <div class="stat-value">R$ {{ faturamento_mes|floatformat:0|default:0 }}</div>
            <div class="stat-label">Faturamento do Mês</div>
            <div class="stat-trend trend-up">
                <i class="fas fa-arrow-up trend-icon"></i>
                {{ consultas_pagas|default:0 }} consultas pagas
            </div>
            <i class="fas fa-dollar-sign stat-icon"></i>
        </div>
    </div>
</div>

<div class="row">
    <!-- Charts Section -->
    <div class="col-lg-8">
        <!-- Procedures Chart -->
        <div class="chart-card">
            <h3 class="section-title">Procedimentos Realizados</h3>
            <div class="chart-container">
                <canvas id="proceduresChart"></canvas>
            </div>
        </div>

        <!-- Appointments Status Chart -->
        <div class="chart-card">
            <h3 class="section-title">Status dos Agendamentos</h3>
            <div class="chart-container">
                <canvas id="appointmentsChart"></canvas>
            </div>
        </div>

        <!-- Revenue Chart -->
        <div class="chart-card">
            <h3 class="section-title">Faturamento dos Últimos 6 Meses</h3>
            <div class="chart-container">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Today's Appointments -->
        <div class="appointments-sidebar">
            <h3 class="section-title">Agendamentos de Hoje</h3>
            
            {% if agendamentos_hoje_lista %}
                {% for agendamento in agendamentos_hoje_lista %}
                <div class="appointment-item">
                    <div class="appointment-time">{{ agendamento.data_hora|time:"H:i" }}</div>
                    <div class="appointment-patient">{{ agendamento.paciente.nome }}</div>
                    <div class="appointment-status {% if agendamento.status == 'confirmado' %}status-confirmed{% else %}status-pending{% endif %}">
                        {{ agendamento.get_status_display }}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="no-appointments">
                    <i class="fas fa-calendar-check" style="font-size: 3rem; color: var(--light-purple); margin-bottom: 1rem;"></i>
                    <p>Nenhum agendamento para hoje</p>
                </div>
            {% endif %}
        </div>

        <!-- Birthdays -->
        {% if aniversariantes_lista %}
        <div class="appointments-sidebar" style="margin-top: 1.5rem;">
            <h3 class="section-title">Aniversariantes de Hoje</h3>
            {% for paciente in aniversariantes_lista %}
            <div class="birthday-item">
                <i class="fas fa-birthday-cake birthday-icon"></i>
                <div>
                    <strong>{{ paciente.nome }}</strong>
                    <br>
                    <small class="text-muted">{{ paciente.telefone }}</small>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
</div>

<!-- Quick Actions -->
<div class="quick-actions">
    <a href="{% url 'core:agenda' %}" class="quick-action-btn">
        <i class="fas fa-plus"></i>
        Novo Agendamento
    </a>
    <a href="{% url 'core:pacientes' %}" class="quick-action-btn">
        <i class="fas fa-user-plus"></i>
        Novo Paciente
    </a>
    <a href="/admin/core/servico/add/" class="quick-action-btn">
        <i class="fas fa-stethoscope"></i>
        Novo Serviço
    </a>
    <a href="/admin/" class="quick-action-btn">
        <i class="fas fa-cog"></i>
        Painel Admin
    </a>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Procedures Donut Chart
    const proceduresCtx = document.getElementById('proceduresChart').getContext('2d');
    new Chart(proceduresCtx, {
        type: 'doughnut',
        data: {
            labels: ['Consultas', 'Exames', 'Procedimentos', 'Retornos'],
            datasets: [{
                data: [{{ consultas_mes|default:17 }}, 8, 5, 12],
                backgroundColor: [
                    '#8e44ad',
                    '#3498db', 
                    '#f39c12',
                    '#27ae60'
                ],
                borderWidth: 0,
                cutout: '60%'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        usePointStyle: true,
                        padding: 20,
                        font: {
                            family: 'Inter',
                            size: 14
                        }
                    }
                }
            }
        }
    });

    // Appointments Status Pie Chart  
    const appointmentsCtx = document.getElementById('appointmentsChart').getContext('2d');
    new Chart(appointmentsCtx, {
        type: 'pie',
        data: {
            labels: ['Confirmados', 'Pendentes', 'Cancelados'],
            datasets: [{
                data: [{{ agendamentos_confirmados|default:2 }}, 3, 1],
                backgroundColor: [
                    '#27ae60',
                    '#f39c12', 
                    '#e74c3c'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        usePointStyle: true,
                        padding: 20,
                        font: {
                            family: 'Inter',
                            size: 14
                        }
                    }
                }
            }
        }
    });

    // Revenue Line Chart
    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
    new Chart(revenueCtx, {
        type: 'line',
        data: {
            labels: ['Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out'],
            datasets: [{
                label: 'Faturamento (R$)',
                data: [12000, 15000, 18000, 14000, 20000, {{ faturamento_mes|default:16000 }}],
                borderColor: '#8e44ad',
                backgroundColor: 'rgba(142, 68, 173, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#8e44ad',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'R$ ' + value.toLocaleString();
                        },
                        font: {
                            family: 'Inter'
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    ticks: {
                        font: {
                            family: 'Inter'
                        }
                    },
                    grid: {
                        display: false
                    }
                }
            }
        }
    });

    // Add click animations to stat cards
    document.querySelectorAll('.stat-card').forEach(card => {
        card.addEventListener('click', function() {
            this.style.transform = 'scale(0.98)';
            setTimeout(() => {
                this.style.transform = 'scale(1)';
            }, 150);
        });
    });
});
</script>
{% endblock %}